""" Script to pull Cuckoo network communications from MongoDB and input it into MySQL
""" 

import sys 
import MySQLdb
import json
import datetime

from pymongo import MongoClient


def connect_mongo(host="127.0.0.1", port=27017):

	return MongoClient(host, port)


def connect_mysql(username, password, database, sql_host='127.0.0.1', sql_port=3306):

	try:
		sql_connection = MySQLdb.connect(host=sql_host, port=sql_port, user=username, passwd=password, db=database)
	except MySQLdb.Error as e:
		print(e)

	return sql_connection


class JSONEncoder(json.JSONEncoder):
    def default(self, o):
        if isinstance(o, ObjectId):
            return str(o)
        return json.JSONEncoder.default(self, o)
# JSONEncoder().encode(stuff)

#def write_hosts_sql(tcp_json, sample_id, ):

if __name__ == '__main__':

	sql_cuckooDB = connect_mysql(username='cuckoo', password='sANDb4ch$', database='sandbox')
	sql_cuckooDB_cursor = sql_cuckooDB.cursor()
	sql_cuckooDB_write_cursor = sql_cuckooDB.cursor()

	mongo_client = connect_mongo()
	mongo_cuckooDB = mongo_client.cuckoo
	analysis_collection = mongo_cuckooDB.analysis
	
	print "FIX ME: tasks_query"
	#tasks_query = "select id from tasks where id >= 177 and status='completed' order by id asc"
	tasks_query = "select id from tasks where id >= 177 and id < 190 and status='reported' order by id asc"
	sql_cuckooDB_cursor.execute(tasks_query)

	i = 0
	sql_cuckoo_task = sql_cuckooDB_cursor.fetchone()
	while sql_cuckoo_task is not None:

		sql_cuckoo_task_id = sql_cuckoo_task[0]
		try:
			analysis_mongo_query = analysis_collection.find({ 'info.id':sql_cuckoo_task_id })
		except Exception as e:
			print "Exception loading Mongo analysis for info.id = %s: " % (sql_cuckoo_task_id) + str(e)
			sql_cuckoo_task = sql_cuckooDB_cursor.fetchone()
			continue

		try:
			analysis_network_hosts = analysis_mongo_query[0]['network']['hosts']
			analysis_network_tcp = analysis_mongo_query[0]['network']['tcp']
			analysis_network_udp = analysis_mongo_query[0]['network']['udp']
			analysis_network_icmp = analysis_mongo_query[0]['network']['icmp']
			analysis_network_smtp = analysis_mongo_query[0]['network']['smtp']
			analysis_network_http = analysis_mongo_query[0]['network']['http']
		except Exception as e:
			print "Exception reading network data from Mongo document info.id %s: " % (sql_cuckoo_task_id) + str(e)
			sql_cuckoo_task = sql_cuckooDB_cursor.fetchone()
			continue

		#print analysis_network
		i += 1
		if (i == 10): break

		sql_cuckoo_task = sql_cuckooDB_cursor.fetchone()

	sql_cuckooDB.close()
	mongo_client.close()

	sys.exit(0)