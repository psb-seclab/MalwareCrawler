import sys
import smtplib
import datetime
import MySQLdb


SQL_USERID = 'cuckoo'
SQL_PASSWD = 'sANDb4ch$'
SQL_DATABASE = 'sandbox'
SQL_HOST = '127.0.0.1'
SQL_PORT = 3306


def send_email(msg):
	try:
		server = smtplib.SMTP("smtp.gmail.com:587")
		fromaddr = "tslns17@gmail.com"
		#toaddr = ["ahankewycz@taasera.com", "mstankiewicz@taasera.com", "cwj5112@psu.edu", "zxiao@taasera.com", "oconnellb@taasera.com"]
		toaddr = ["YEOSS@yahoo.com"]
		server.starttls()
		server.login("tslns17@gmail.com","$H523Jts")

		for person in toaddr:
			server.sendmail(fromaddr,person,msg)

	except smtplib.SMTPAuthenticationError:
		sys.stderr.write("Failed to send email")

def connect_mysql(username, password, database, sql_host='127.0.0.1', sql_port=3306):

	try:
		sql_connection = MySQLdb.connect(host=sql_host, port=sql_port, user=username, passwd=password, db=database)
	except MySQLdb.Error as e:
		print(e)

	return sql_connection


if __name__ == '__main__':
	sql_connection = connect_mysql(SQL_USERID, SQL_PASSWD, SQL_DATABASE, SQL_HOST, SQL_PORT)
	sql_cursor = sql_connection.cursor()

	today = datetime.date.today()
	one_day = datetime.timedelta(days=1)
	tomorrow = today + one_day

	qry_tasks_no_profiles =	'select tasks.id, samples.md5 from \
							(tasks inner join samples on tasks.sample_id=samples.id) \
							where tasks.id not in \
							(select tasks.id from \
								((tasks inner join Aware7B1C_profile \
								on tasks.started_on < Aware7B1C_profile.profile_receipt_datetime \
								and tasks.completed_on > Aware7B1C_profile.start) \
								inner join samples on tasks.sample_id=samples.id) \
							where tasks.started_on >= %s and tasks.started_on < %s) \
							and tasks.started_on >= %s and tasks.started_on < %s'

	sql_cursor.execute(qry_tasks_no_profiles, (today,tomorrow,today,tomorrow))
	tasks_without_profiles = sql_cursor.fetchall()

	message = ''

	for task in tasks_without_profiles:
		message = message + str(int(task[0])) + '\t' + task[1] + '\n'

	send_email(message)

	sql_cursor.close()
	sql_connection.close()